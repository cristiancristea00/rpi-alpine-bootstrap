# /etc/sysctl.d/99-config.conf
#
# Generic router-ish sysctl profile for a multi-homed Linux host with:
#   - two L3 interfaces (eth0 + wlan0)
#   - IPv4 + IPv6
#   - services that may use fwmarks/policy routing (e.g., VPN tunnels)
#
# IMPORTANT ABOUT ORDER:
#   - net.ipv4.ip_forward is “special”: changing it resets a bunch of IPv4
#     interface defaults (host vs router defaults). So keep ip_forward near the
#     top, and keep your per-interface tweaks AFTER it.


#================================================================================
#================================================================================
# IPv4 (routing behavior + multi-homing hygiene on eth0/wlan0)
#================================================================================
#================================================================================


# Enable IPv4 forwarding (this makes the box act like a router for IPv4).
net.ipv4.ip_forward = 1

# -------------------------------------------------------------------------------
# Redirects and source routing (hardening + predictability)
# -------------------------------------------------------------------------------
# ICMP redirects are rarely desirable on modern hosts/routers (attack surface,
# “mysterious” route changes). Disable both sending and accepting.
#
# NOTE: For some knobs, Linux uses “conf/all” as a master switch. If conf/all
# remains enabled, setting only eth0/wlan0 may not fully disable the feature.
net.ipv4.conf.all.accept_redirects  = 0
net.ipv4.conf.all.secure_redirects  = 0
net.ipv4.conf.all.send_redirects    = 0
net.ipv4.conf.all.accept_source_route = 0

# Apply explicitly to eth0/wlan0 too (clarity + protects if per-if defaults change).
net.ipv4.conf.eth0.accept_redirects = 0
net.ipv4.conf.wlan0.accept_redirects = 0

net.ipv4.conf.eth0.secure_redirects = 0
net.ipv4.conf.wlan0.secure_redirects = 0

net.ipv4.conf.eth0.send_redirects = 0
net.ipv4.conf.wlan0.send_redirects = 0

net.ipv4.conf.eth0.accept_source_route = 0
net.ipv4.conf.wlan0.accept_source_route = 0

# Log “martians” (packets with impossible/bogus source addresses) per interface.
# Useful when you’re running public services and want visibility into spoofing/noise.
net.ipv4.conf.eth0.log_martians = 1
net.ipv4.conf.wlan0.log_martians = 1

# -------------------------------------------------------------------------------
# Reverse-path filtering (anti-spoofing) tuned for multi-homing / policy routing
# -------------------------------------------------------------------------------
# rp_filter helps mitigate source-spoofing by checking the reverse path.
# - 1 = strict (best security, but breaks easily with asymmetric routing)
# - 2 = loose  (works with multi-homing / multiple uplinks / policy routing)
#
# For a box with multiple default routes and/or fwmark-based policy routing, loose
# mode is usually the practical choice.
net.ipv4.conf.eth0.rp_filter = 2
net.ipv4.conf.wlan0.rp_filter = 2

# If you rely on fwmarks for routing decisions, include the fwmark in the reverse
# path lookup so rp_filter can work as intended in both directions.
net.ipv4.conf.eth0.src_valid_mark = 1
net.ipv4.conf.wlan0.src_valid_mark = 1

# -------------------------------------------------------------------------------
# ARP behavior (avoid “ARP flux” when eth0 and wlan0 are on the same L2/subnet)
# -------------------------------------------------------------------------------
# Linux “owns” IPv4 addresses at the host level; without tuning, either interface
# may answer ARP for the other’s address (“ARP flux”). That can confuse peers and
# break return-path symmetry.
#
# arp_filter=1: answer ARP based on whether routing would send traffic back out
#               that same interface (works best with source/policy routing).
net.ipv4.conf.eth0.arp_filter = 1
net.ipv4.conf.wlan0.arp_filter = 1

# arp_announce=2: when sending ARP, prefer the best local source address for the
#                 target (avoids announcing an address that “belongs” to the other NIC).
net.ipv4.conf.eth0.arp_announce = 2
net.ipv4.conf.wlan0.arp_announce = 2

# arp_ignore=1: only reply to ARP if the target IP is configured on the incoming interface.
net.ipv4.conf.eth0.arp_ignore = 1
net.ipv4.conf.wlan0.arp_ignore = 1

# Optional (more aggressive ARP hardening; can break some legit workflows):
# - drop_gratuitous_arp=1 drops unsolicited ARP updates (helps against certain LAN attacks)
# net.ipv4.conf.eth0.drop_gratuitous_arp = 1
# net.ipv4.conf.wlan0.drop_gratuitous_arp = 1


#================================================================================
#================================================================================
# IPv6 (routing + Router Advertisements on eth0/wlan0)
#================================================================================
#================================================================================


# Enable IPv6 globally.
net.ipv6.conf.all.disable_ipv6 = 0

# Enable IPv6 forwarding (router behavior). Many distros disable RA processing
# automatically when forwarding=1, so we’ll explicitly re-enable RA on uplinks.
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.forwarding = 1

# Per-interface forwarding (explicit).
net.ipv6.conf.eth0.forwarding = 1
net.ipv6.conf.wlan0.forwarding = 1

# -------------------------------------------------------------------------------
# Router Advertisements (RA) while forwarding is enabled
# -------------------------------------------------------------------------------
# accept_ra:
#   0 = ignore RA
#   1 = accept RA (typical host behavior)
#   2 = accept RA even if forwarding=1 (useful for “router host” setups)
#
# If eth0/wlan0 are your *upstream* interfaces that receive default route/prefixes
# via RA, you typically want accept_ra=2 on those interfaces.
net.ipv6.conf.eth0.accept_ra = 2
net.ipv6.conf.wlan0.accept_ra = 2

# These control which RA information you accept (defaults track accept_ra, but we
# set them explicitly for readability).
net.ipv6.conf.eth0.accept_ra_defrtr = 1
net.ipv6.conf.wlan0.accept_ra_defrtr = 1

net.ipv6.conf.eth0.accept_ra_pinfo = 1
net.ipv6.conf.wlan0.accept_ra_pinfo = 1

net.ipv6.conf.eth0.accept_ra_rtr_pref = 1
net.ipv6.conf.wlan0.accept_ra_rtr_pref = 1

# autoconf controls SLAAC address configuration from RA prefix information.
net.ipv6.conf.eth0.autoconf = 1
net.ipv6.conf.wlan0.autoconf = 1

# -------------------------------------------------------------------------------
# Redirects and source routing (IPv6 hardening)
# -------------------------------------------------------------------------------
# Disable ICMPv6 redirects and IPv6 Routing Headers (source routing).
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0
net.ipv6.conf.eth0.accept_redirects = 0
net.ipv6.conf.wlan0.accept_redirects = 0

# accept_source_route:
#   <0: do not accept routing header
#    0: accept only type 2 (legacy; generally best avoided)
#   >0: accept all routing headers
net.ipv6.conf.all.accept_source_route = -1
net.ipv6.conf.default.accept_source_route = -1
net.ipv6.conf.eth0.accept_source_route = -1
net.ipv6.conf.wlan0.accept_source_route = -1

# -------------------------------------------------------------------------------
# Privacy extensions (optional; choose based on whether you host inbound services)
# -------------------------------------------------------------------------------
# use_tempaddr:
#   0  = disable temporary addresses (stable addressing; better for servers)
#   1  = enable temporary addresses but prefer stable/public addresses
#   2+ = prefer temporary addresses (better privacy for client endpoints)
#
# For a box that hosts services (VPN, relays), 0 is usually the least surprising.
net.ipv6.conf.eth0.use_tempaddr = 0
net.ipv6.conf.wlan0.use_tempaddr = 0


#================================================================================
#================================================================================
# PERFORMANCE (generic, safe-ish defaults; adjust to your workload)
#================================================================================
#================================================================================


# Queueing discipline:
# fq is a good “modern default” for many cases (especially with BBR), improving
# fairness/latency under load.
net.core.default_qdisc = fq

# TCP congestion control:
# - “reno” always exists
# - “cubic” is common default
# - “bbr” can improve throughput/latency on many links (requires kernel support)
#
# If your kernel doesn’t have bbr, this will fail to apply; set to “cubic”.
net.ipv4.tcp_congestion_control = bbr

# Socket buffer sizing (system-wide caps and defaults).
# These affect TCP/UDP and can matter for high-bandwidth/high-latency paths.
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.rmem_max     = 16777216
net.core.wmem_max     = 16777216

# TCP autotuning ranges (min, default, max).
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# UDP minimum buffers (some workloads benefit; harmless for most).
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

# Increase input packet backlog to handle bursts (especially on fast LAN/Wi-Fi).
net.core.netdev_max_backlog = 16384

# Listen backlog cap (upper bound for listen(backlog)).
# 4096 is the modern default on many kernels; raising can help very bursty servers.
net.core.somaxconn = 4096

# Max queued half-open (SYN_RECV) connections for TCP.
# Helps under bursts; too high can increase memory usage.
net.ipv4.tcp_max_syn_backlog = 4096

# Path MTU probing (helps when PMTU black-holes exist; mild overhead).
# 0=off, 1=probe when needed, 2=always probe
net.ipv4.tcp_mtu_probing = 1

# TCP keepalive (useful for cleaning up dead sessions; tune to your environment).
net.ipv4.tcp_keepalive_time  = 600
net.ipv4.tcp_keepalive_intvl = 60
net.ipv4.tcp_keepalive_probes = 5

# Ephemeral port range (more headroom for many outbound connections).
net.ipv4.ip_local_port_range = 10240 65535

# TCP Fast Open (RFC7413): 0=off, 1=client, 2=server, 3=both.
# Only helps apps that explicitly use/enable it.
net.ipv4.tcp_fastopen = 3


#================================================================================
#================================================================================
# SECURITY (kernel-level hygiene; NOT a substitute for a real firewall)
#================================================================================
#================================================================================


# Mitigate TIME_WAIT assassination hazards (RFC 1337 fix)
net.ipv4.tcp_rfc1337 = 1

# SYN cookies help with SYN flood scenarios (only used when the SYN backlog overflows).
net.ipv4.tcp_syncookies = 1

# Basic ICMP hardening.
# - ignore broadcast pings (smurf-style amplification)
net.ipv4.icmp_echo_ignore_broadcasts = 1
# - ignore bogus ICMP errors (mostly reduces log noise from broken routers)
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Drop unicast packets received in L2 multicast/broadcast frames.
# This is a SHOULD in RFC 1122 (IPv4) and helps against some spoofing/odd L2 attacks.
net.ipv4.conf.eth0.drop_unicast_in_l2_multicast = 1
net.ipv4.conf.wlan0.drop_unicast_in_l2_multicast = 1
net.ipv6.conf.eth0.drop_unicast_in_l2_multicast = 1
net.ipv6.conf.wlan0.drop_unicast_in_l2_multicast = 1

# Optional (more aggressive IPv6 ND hardening; can break some networks):
# - drop_unsolicited_na drops unsolicited Neighbor Advertisements (mitigates some Wi-Fi ND attacks)
# net.ipv6.conf.eth0.drop_unsolicited_na = 1
# net.ipv6.conf.wlan0.drop_unsolicited_na = 1
